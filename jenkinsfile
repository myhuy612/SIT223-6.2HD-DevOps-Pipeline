pipeline {
    agent any
    environment {
        DIRECTORY_PATH = "C:/Users/myhuy/Documents/jenkins"
        DOCKER_IMAGE = "mywebapp_image"
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        DOCKER_CONTAINER = "mywebapp_container"
    }

    stages {
        stage('Checkout Code') {
            steps {
                // Task: Checkout the source code from GitHub
                // Tool: Git
                git url: 'https://github.com/myhuy612/SIT223-6.2HD-DevOps-Pipeline.git', branch: 'main'
                echo "Code has been checked out from GitHub"
            }
        }
        stage('Build Docker Image') {
            steps {
                script {
                    echo "Building Docker image ${DOCKER_IMAGE}:${DOCKER_TAG}..."
                    bat "docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} ."
                }
            }
        }
        stage('Push Docker Image') {
            steps {
                script {
                    echo "Pushing Docker image to DockerHub..."
                    withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                        bat "docker login -u %DOCKER_USERNAME% -p %DOCKER_PASSWORD%"
                        bat "docker push ${DOCKER_IMAGE}:${DOCKER_TAG}"
                    }
                }
            }
        }
        stage('Unit and Integration Tests') {
            steps {
                // Task: Run automated tests using Selenium WebDriver (Python)
                script {
                    echo "Running unit and integration tests..."
                    bat '''
                    docker run -d --name selenium_test_container -v %WORKSPACE%:/app selenium/standalone-chrome
                    docker exec selenium_test_container python -m unittest discover tests/
                    '''
                }
            }
            post {
                success {
                    emailext to: 'myhuylim00302@gmail.com',
                    subject: 'Pipeline Success - Unit and Integration Tests',
                    body: 'All tests passed successfully!',
                    attachLog: true
                }
                failure {
                    emailext to: 'myhuylim00302@gmail.com',
                    subject: 'Pipeline Failure - Unit and Integration Tests',
                    body: 'Unit and integration tests failed. Please review the logs.',
                    attachLog: true
                }
            }
        }
        stage('Code Quality Analysis') {
            steps {
                // Task: Analyze the code quality using SonarQube
                script {
                    echo "Running code quality analysis with SonarQube..."
                    bat '''
                    sonar-scanner \
                    -Dsonar.projectKey=my-webapp \
                    -Dsonar.sources=. \
                    -Dsonar.host.url=http://localhost:9000 \
                    -Dsonar.login=sqp_45141d7211cb7a4e8b298f2ec15673cc63da3bf3
                    '''
                }
            }
        }
        stage('Deploy to Staging') {
            steps {
                script {
                    echo "Deploying the application to the staging environment..."
                    bat '''
                    docker stop ${DOCKER_CONTAINER} || echo "No container to stop"
                    docker rm ${DOCKER_CONTAINER} || echo "No container to remove"
                    docker run -d --name ${DOCKER_CONTAINER} -p 8080:80 ${DOCKER_IMAGE}:${DOCKER_TAG}
                    '''
                }
            }
        }
        stage('Release to Production') {
            steps {
                script {
                    echo "Deploying the application to the production environment..."
                    bat '''
                    docker stop ${DOCKER_CONTAINER} || echo "No container to stop"
                    docker rm ${DOCKER_CONTAINER} || echo "No container to remove"
                    docker run -d --name ${DOCKER_CONTAINER} -p 80:80 ${DOCKER_IMAGE}:${DOCKER_TAG}
                    '''
                }
          
